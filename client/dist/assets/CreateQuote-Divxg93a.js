import{j as e,A as N}from"./index-C5bGCW4r.js";import{b as r,f as se,c as ae}from"./vendor-hBbQJCfh.js";import{a as E}from"./authFetch-CQWmCeCA.js";import{A as ne}from"./arrow-left-DP78AEqu.js";import{T as re}from"./trash-2-BCfEatWq.js";import{P as le}from"./plus-BroQ0DqQ.js";const M=({label:d,value:p,onChange:y,onSelect:v,placeholder:I,fetchSuggestions:C})=>{const[f,h]=r.useState([]),[b,u]=r.useState(!1),[A,_]=r.useState(!1),g=r.useRef(null);return r.useEffect(()=>{function i(m){g.current&&!g.current.contains(m.target)&&u(!1)}return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[g]),r.useEffect(()=>{const i=setTimeout(async()=>{if(p&&p.length>1&&b){_(!0);try{const m=await C(p);h(m)}catch(m){console.error("Autocomplete error:",m),h([])}finally{_(!1)}}else h([])},300);return()=>clearTimeout(i)},[p,b,C]),e.jsxs("div",{className:"autocomplete-wrapper",ref:g,style:{position:"relative"},children:[d&&e.jsx("label",{style:{display:"block",marginBottom:"0.5rem",fontWeight:500},children:d}),e.jsx("input",{type:"text",className:"input",value:p,onChange:i=>{y(i.target.value),u(!0)},onFocus:()=>u(!0),placeholder:I}),b&&f.length>0&&e.jsx("ul",{style:{position:"absolute",top:"100%",left:0,right:0,background:"white",border:"1px solid var(--border)",borderRadius:"var(--radius-md)",boxShadow:"var(--shadow-md)",listStyle:"none",padding:0,margin:"4px 0 0 0",zIndex:100,maxHeight:"200px",overflowY:"auto"},children:f.map((i,m)=>e.jsx("li",{onClick:()=>{v(i),u(!1)},style:{padding:"0.5rem 1rem",cursor:"pointer",borderBottom:m===f.length-1?"none":"1px solid var(--border)"},onMouseEnter:w=>w.target.style.background="var(--background)",onMouseLeave:w=>w.target.style.background="white",children:i.label||i.name},i.id||m))})]})},ue=()=>{const{id:d}=se(),p=ae(),[y,v]=r.useState(""),[I,C]=r.useState(null),[f,h]=r.useState(""),[b,u]=r.useState(""),[A,_]=r.useState(new Date().toISOString().split("T")[0]),[g,i]=r.useState("DRAFT"),[m,w]=r.useState([]),[l,R]=r.useState(null),[x,T]=r.useState([{id:Date.now(),item_id:null,model_number:"",name:"",description:"",hsn_code:"",rate:0,tax_rate:0,quantity:1,is_manual:!0}]),[B,F]=r.useState(!1),[D,P]=r.useState("PERCENT"),[S,q]=r.useState(0),[O,$]=r.useState(""),[L,k]=r.useState("");r.useEffect(()=>{G(),d&&W(),d||k(`1. Goods once sold will not be taken back.
2. Interest @ 18% p.a. will be charged if payment is not made within the due date.
3. Subject to Panipat Jurisdiction only.`)},[d]);const G=async()=>{try{const s=await(await E(`${N}/api/companies`)).json();if(w(s),!d&&s.length>0){const a=s.find(n=>n.is_default)||s[0];R(a)}}catch(t){console.error("Error fetching companies:",t)}},W=async()=>{try{F(!0);const t=await E(`${N}/api/quotations/${d}`);if(t.ok){const s=await t.json();if(v(s.client_name),C(s.client_id),h(s.client_address||""),u(s.client_gstin||""),_(s.date),i(s.status||"DRAFT"),P(s.discount_type||"PERCENT"),q(s.discount_value||0),$(s.notes||""),k(s.terms||""),s.company_snapshot)try{R(typeof s.company_snapshot=="string"?JSON.parse(s.company_snapshot):s.company_snapshot)}catch(n){console.error("Error parsing company snapshot",n)}const a=s.items.map(n=>({id:n.id||Date.now()+Math.random(),item_id:n.item_id,model_number:n.model_number||"",name:n.name,description:n.description||"",note:n.note||"",hsn_code:n.hsn_code||"",rate:n.rate||0,tax_rate:n.tax_rate||0,quantity:n.quantity,is_manual:!!n.is_manual}));T(a)}}catch(t){console.error("Error fetching quote",t)}finally{F(!1)}},z=async t=>await(await E(`${N}/api/clients/search?q=${t}`)).json(),Q=async t=>{const a=await(await E(`${N}/api/items`)).json(),n=t.toLowerCase();return a.filter(o=>o.name.toLowerCase().includes(n)||o.model_number&&o.model_number.toLowerCase().includes(n)||o.description&&o.description.toLowerCase().includes(n)).map(o=>({...o,label:`${o.name} ${o.model_number?`(${o.model_number})`:""} - ${o.description||"No Desc"}`}))},U=t=>{v(t.name),C(t.id),h(t.address||""),u(t.gstin||"")},V=(t,s)=>{const a=[...x];a[t]={...a[t],item_id:s.id,model_number:s.model_number||s.model||"",name:s.name,description:s.description||s.desc||"",hsn_code:s.hsn_code||s.hsn||"",rate:s.rate||0,tax_rate:s.tax_rate||0,is_manual:!1},T(a)},j=(t,s,a)=>{const n=[...x];n[t][s]=a,T(n)},H=()=>{T([...x,{id:Date.now(),model_number:"",name:"",description:"",hsn_code:"",rate:0,tax_rate:0,quantity:1,is_manual:!0}])},J=t=>{x.length>1&&T(x.filter((s,a)=>a!==t))},K=()=>{let t=0,s=0;x.forEach(o=>{const c=o.rate*o.quantity;t+=c,s+=c*(o.tax_rate/100)});let a=0;D==="PERCENT"?a=t*(S/100):a=parseFloat(S)||0;const n=t+s-a;return{subtotal:t,totalTax:s,discountAmount:a,grandTotal:n}},{subtotal:Y,totalTax:X,grandTotal:Z}=K(),ee=async t=>{t.preventDefault();let s=I;if(!y)return alert("Client name required");const a={client_id:s,client_name:y,client_address:f,client_gstin:b,date:A,status:g,discount_type:D,discount_value:parseFloat(S),notes:O,terms:L,items:x.map(c=>({...c,rate:parseFloat(c.rate),quantity:parseFloat(c.quantity),tax_rate:parseFloat(c.tax_rate)})),company_snapshot:l},n=d?`${N}/api/quotations/${d}`:`${N}/api/quotations`,o=d?"PUT":"POST";try{const c=await E(n,{method:o,body:JSON.stringify(a),headers:{"Content-Type":"application/json"}});if(c.ok)p("/quotations");else{const te=await c.json();alert(`Failed to save: ${te.error||"Unknown error"}`)}}catch(c){console.error(c),alert(`Error saving: ${c.message}`)}};return B?e.jsx("div",{children:"Loading..."}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("div",{className:"card mb-6",style:{border:"1px solid #ddd",padding:"20px"},children:e.jsx("div",{style:{display:"flex",justifyContent:"space-between",borderBottom:"2px solid var(--primary-color)",paddingBottom:"20px"},children:e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"flex justify-between items-start mb-4",children:e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1",children:"From Company"}),e.jsx("select",{className:"border border-gray-300 rounded p-1 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none",value:l?.id||"",onChange:t=>{const s=m.find(a=>a.id===parseInt(t.target.value));s&&R(s)},children:m.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]})}),l?e.jsxs(e.Fragment,{children:[e.jsx("h1",{style:{fontSize:"1.5rem",fontWeight:800,color:"#0f172a",margin:0},children:l.name}),e.jsx("p",{style:{margin:"5px 0",fontSize:"0.9rem",fontWeight:500},children:l.address}),e.jsxs("div",{className:"flex gap-4 text-sm mt-2",children:[l.gstin&&e.jsxs("p",{children:[e.jsx("strong",{children:"GSTIN:"})," ",l.gstin]}),l.pan&&e.jsxs("p",{children:[e.jsx("strong",{children:"PAN:"})," ",l.pan]})]}),e.jsxs("p",{style:{margin:"5px 0 0 0",fontSize:"0.8rem"},children:[l.phone&&e.jsxs("span",{style:{marginRight:"10px"},children:["ðŸ“ž ",l.phone]}),l.email&&e.jsxs("span",{children:["âœ‰ï¸ ",l.email]})]})]}):e.jsx("p",{className:"text-red-500",children:"Please create a company profile in Settings"})]})})}),e.jsxs("div",{className:"flex-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>p(-1),className:"btn btn-secondary p-2",children:e.jsx(ne,{size:20})}),e.jsx("h1",{className:"text-2xl font-bold",children:d?"Edit Quotation":"New Quotation"})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("input",{type:"date",className:"input",value:A,onChange:t=>_(t.target.value)}),e.jsxs("select",{className:"input",value:g,onChange:t=>i(t.target.value),children:[e.jsx("option",{value:"DRAFT",children:"Draft"}),e.jsx("option",{value:"SENT",children:"Sent"}),e.jsx("option",{value:"ACCEPTED",children:"Accepted"}),e.jsx("option",{value:"REJECTED",children:"Rejected"})]})]})]}),e.jsxs("form",{onSubmit:ee,children:[e.jsx("div",{className:"card mb-6 grid grid-cols-2 gap-6 mobile-stack",children:e.jsxs("div",{children:[e.jsx(M,{label:"Client Name",value:y,onChange:v,onSelect:U,fetchSuggestions:z,placeholder:"Enter Client Name"}),e.jsx("textarea",{className:"input mt-2",placeholder:"Address",rows:"3",value:f,onChange:t=>h(t.target.value)}),e.jsx("input",{className:"input mt-2",placeholder:"GSTIN",value:b,onChange:t=>u(t.target.value)})]})}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"table-container",style:{overflow:"visible"},children:[e.jsxs("div",{className:"item-row-header",style:{display:"grid",gridTemplateColumns:"40px 3fr 1fr 1fr 1fr 1fr 1fr 40px",gap:"10px",fontWeight:600,paddingBottom:"10px",borderBottom:"1px solid var(--border)",color:"var(--text-secondary)",minWidth:"800px"},children:[e.jsx("span",{children:"#"}),e.jsx("span",{children:"Item Details"}),e.jsx("span",{children:"HSN"}),e.jsx("span",{children:"Rate"}),e.jsx("span",{children:"Tax %"}),e.jsx("span",{children:"Qty"}),e.jsx("span",{children:"Total"}),e.jsx("span",{})]}),e.jsx("div",{className:"flex flex-col gap-4 mt-4",children:x.map((t,s)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"40px 3fr 1fr 1fr 1fr 1fr 1fr 40px",gap:"10px",alignItems:"start",minWidth:"800px"},children:[e.jsx("span",{style:{paddingTop:"8px"},children:s+1}),e.jsxs("div",{children:[e.jsx(M,{placeholder:"Search Item...",value:t.name,onChange:a=>j(s,"name",a),onSelect:a=>V(s,a),fetchSuggestions:Q}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"5px"},children:[e.jsx("input",{placeholder:"Model",className:"input text-sm",value:t.model_number,onChange:a=>j(s,"model_number",a.target.value)}),e.jsx("input",{placeholder:"Description",className:"input text-sm",value:t.description,onChange:a=>j(s,"description",a.target.value)})]})]}),e.jsx("input",{className:"input",value:t.hsn_code,onChange:a=>j(s,"hsn_code",a.target.value),placeholder:"HSN"}),e.jsx("input",{type:"number",className:"input",value:t.rate,onChange:a=>j(s,"rate",a.target.value)}),e.jsx("input",{type:"number",className:"input",value:t.tax_rate,onChange:a=>j(s,"tax_rate",a.target.value)}),e.jsx("input",{type:"number",className:"input",value:t.quantity,onChange:a=>j(s,"quantity",a.target.value)}),e.jsxs("div",{className:"font-bold py-2 text-right",children:["â‚¹",(t.rate*t.quantity).toFixed(2)]}),e.jsx("button",{type:"button",onClick:()=>J(s),className:"text-red-500 hover:text-red-700 py-2",children:e.jsx(re,{size:18})})]},t.id))}),e.jsxs("button",{type:"button",onClick:H,className:"btn btn-secondary mt-4 w-full dashed-border",children:[e.jsx(le,{size:16})," Add Item"]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsxs("div",{className:"w-64",children:[e.jsxs("div",{className:"flex-between mb-2",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["â‚¹",Y.toFixed(2)]})]}),e.jsxs("div",{className:"flex-between mb-2",children:[e.jsx("span",{children:"Total Tax"}),e.jsxs("span",{children:["â‚¹",X.toFixed(2)]})]}),e.jsxs("div",{className:"flex-between mb-2 items-center",children:[e.jsx("span",{children:"Discount"}),e.jsxs("div",{className:"flex gap-1",style:{width:"60%"},children:[e.jsxs("select",{className:"input py-1 px-2 text-sm",style:{width:"40%"},value:D,onChange:t=>P(t.target.value),children:[e.jsx("option",{value:"PERCENT",children:"%"}),e.jsx("option",{value:"FIXED",children:"â‚¹"})]}),e.jsx("input",{type:"number",className:"input py-1 px-2 text-sm",style:{width:"60%"},value:S,onChange:t=>q(t.target.value)})]})]}),e.jsxs("div",{className:"flex-between pt-2 border-t font-bold text-lg",children:[e.jsx("span",{children:"Grand Total"}),e.jsxs("span",{children:["â‚¹",Z.toFixed(2)]})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 mt-6 mb-6 mobile-stack",children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Bank Details (Preview)"}),e.jsx("div",{className:"text-xs text-gray-600 bg-gray-50 p-2 rounded border leading-tight",children:l?e.jsxs("div",{className:"grid grid-cols-[80px_1fr] gap-1",children:[e.jsx("span",{className:"text-gray-500",children:"Bank:"}),e.jsx("span",{className:"font-medium",children:l.bank_name}),e.jsx("span",{className:"text-gray-500",children:"A/C Name:"}),e.jsx("span",{className:"font-medium",children:l.account_holder_name}),e.jsx("span",{className:"text-gray-500",children:"A/C No:"}),e.jsx("span",{className:"font-medium",children:l.account_no}),e.jsx("span",{className:"text-gray-500",children:"IFSC:"}),e.jsx("span",{className:"font-medium",children:l.ifsc}),l.upi_id&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500 mt-1",children:"UPI:"}),e.jsx("span",{className:"font-bold mt-1",children:l.upi_id})]})]}):e.jsx("p",{children:"No Company Selected"})}),e.jsx("h3",{className:"font-semibold mt-4 mb-2",children:"Notes"}),e.jsx("textarea",{className:"input h-24",placeholder:"Add additional notes here...",value:O,onChange:t=>$(t.target.value)})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Terms & Conditions"}),e.jsx("textarea",{className:"input h-64",placeholder:"Enter terms and conditions...",value:L,onChange:t=>k(t.target.value)})]})]}),e.jsxs("div",{className:"card mt-6 text-center text-xs text-gray-500 mb-20",children:[e.jsx("p",{className:"font-bold mb-1",children:"CONTACT FOR:"}),e.jsxs("p",{children:["CCTV CAMERAS â€¢ INTERNET NETWORKING EQUIPMENT â€¢ FTTH AND RADIO FREQUENCY NETWORKING DEVICES",e.jsx("br",{}),"INTERNET MARKETING â€¢ WEB & APP DEVELOPMENT â€¢ SOCIAL MEDIA MANAGEMENT â€¢ SEO AND MORE"]})]}),e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 p-4 bg-white border-t flex justify-end gap-2 shadow-lg",style:{zIndex:100},children:[e.jsx("button",{type:"button",onClick:()=>p("/quotations"),className:"btn btn-secondary",children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",children:"Save Quotation"})]})]})]})};export{ue as default};
